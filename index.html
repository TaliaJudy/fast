<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Cytra Speed Test</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root { --bg:#0b1220; --card:#121a2b; --text:#eef2ff; --muted:#96a0c8; --accent:#4f7cff; --good:#11c46a; --warn:#ffb020;}
    * { box-sizing: border-box; }
    body { margin:0; font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; background:var(--bg); color:var(--text); overflow-x:hidden; }
    .wrap { max-width: 820px; margin: 40px auto; padding: 0 16px; position: relative; }
    .card { position: relative; background:var(--card); border-radius: 20px; padding: 22px; box-shadow: 0 10px 30px rgba(0,0,0,0.25); overflow:hidden; }
    h1 { margin: 8px 0 16px; font-size: 34px; font-weight: 800; background: linear-gradient(90deg,#4f7cff,#7f9dff); -webkit-background-clip: text; -webkit-text-fill-color: transparent; text-align:center;}
    p.muted { color: var(--muted); margin-top: 4px; text-align:center;}
    .grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px; margin-top: 16px; }
    .tile { background:#0e1627; border:1px solid #1e2a46; border-radius:16px; padding:16px; text-align:center; }
    .tile h2 { font-size: 14px; color: var(--muted); margin:0 0 12px; }
    .big { font-size: 28px; font-weight: 700; letter-spacing: .3px; }
    .row { display:flex; gap:12px; align-items:center; margin-top: 14px; flex-wrap: wrap; justify-content:center;}
    input, button, select {
      background:#0e1627; color:var(--text); border:1px solid #1e2a46; border-radius:12px; padding:10px 12px; font-size:14px;
    }
    input[type="number"] { width: 120px; }
    button { cursor: pointer; transition: all 0.2s ease; }
    .primary { background: var(--accent); border: none; color: white; font-weight: 600; }
    .primary:hover { transform: scale(1.05); box-shadow: 0 0 15px rgba(79,124,255,0.5); }
    .ghost { background: transparent; color: var(--muted);}
    .bar { height:10px; background:#101a31; border-radius:999px; overflow:hidden; }
    .bar > div { height: 100%; width: 0%; background: linear-gradient(90deg, #4f7cff, #7f9dff); transition: width .2s ease-out; }
    .log { margin-top:16px; font-family: ui-monospace, SFMono-Regular, Menlo, monospace; font-size: 12px; white-space: pre-wrap; color:#c6d0ff; max-height: 140px; overflow:auto; background:#0a1120; border:1px solid #192544; padding:12px; border-radius:12px;}
    .hint { font-size:12px; color: var(--muted); }
    footer { text-align:center; margin-top:20px; color:#96a0c8; font-size:14px; }
    /* Brand watermark top-right */
    .brand { position:absolute; top:12px; right:20px; font-size:14px; color:var(--muted); font-weight:bold; opacity:0.8; }
    /* Huge faint background watermark */
    .watermark {
      position:absolute;
      top:50%; left:50%;
      transform: translate(-50%,-50%) rotate(-20deg);
      font-size:100px;
      font-weight:900;
      color: rgba(255,255,255,0.03);
      pointer-events:none;
      user-select:none;
      white-space:nowrap;
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <div class="brand">by Cytra üöÄ</div>
      <div class="watermark">CYTRA</div>
      <h1>Cytra Speed Test</h1>
      <p class="muted">Runs ping, download, and upload against your backend.</p>

      <div class="row">
        <label>Backend URL</label>
        <input id="baseUrl" value="http://localhost:5000" />
      </div>

      <div class="row">
        <label>Download size (MB)</label>
        <input id="dlSize" type="number" min="1" step="1" value="100" />
        <label>Upload size (MB)</label>
        <input id="ulSize" type="number" min="1" step="1" value="20" />
      </div>

      <div class="row">
        <button id="startBtn" class="primary">üöÄ Start Test</button>
        <button id="stopBtn" class="ghost">‚èπÔ∏è Stop</button>
      </div>

      <div class="grid">
        <div class="tile">
          <h2>Ping</h2>
          <div class="big" id="pingVal">‚Äì ms</div>
          <div class="hint" id="pingHint">5 samples avg</div>
        </div>
        <div class="tile">
          <h2>Download</h2>
          <div class="big" id="downVal">‚Äì Mbps</div>
          <div class="bar"><div id="downBar"></div></div>
        </div>
        <div class="tile">
          <h2>Upload</h2>
          <div class="big" id="upVal">‚Äì Mbps</div>
          <div class="bar"><div id="upBar"></div></div>
        </div>
      </div>

      <div class="log" id="log"></div>
    </div>
    <footer>üî• Powered by <strong>Cytra</strong></footer>
  </div>

  <script>
    const $ = (id) => document.getElementById(id);
    const log = (m) => { const el = $("log"); el.textContent += m + "\\n"; el.scrollTop = el.scrollHeight; };

    let abortDownload = null;
    let aborted = false;

    $("stopBtn").onclick = () => {
      aborted = true;
      if (abortDownload) abortDownload();
      log("‚èπÔ∏è Stopping current test...");
    };

    $("startBtn").onclick = async () => {
      aborted = false;
      $("downBar").style.width = "0%";
      $("upBar").style.width = "0%";
      $("downVal").textContent = "‚Ä¶";
      $("upVal").textContent = "‚Ä¶";
      $("pingVal").textContent = "‚Ä¶";
      log("üöÄ Starting tests‚Ä¶");

      try {
        const base = $("baseUrl").value.replace(/\\/$/, "");
        await runPing(base);
        if (aborted) return;
        await runDownload(base);
        if (aborted) return;
        await runUpload(base);
      } catch (e) {
        log("‚ùå " + (e?.message || e));
      }
    };

    async function runPing(base) {
      const tries = 5;
      let sum = 0;
      for (let i = 0; i < tries; i++) {
        const t0 = performance.now();
        await fetch(base + "/ping", { cache: "no-store" });
        const dt = performance.now() - t0;
        sum += dt;
        $("pingVal").textContent = dt.toFixed(1) + " ms";
        log(`üìç Ping #${i+1}: ${dt.toFixed(1)} ms`);
      }
      const avg = sum / tries;
      $("pingVal").textContent = avg.toFixed(1) + " ms";
      $("pingHint").textContent = `${tries} samples avg`;
      log(`‚úÖ Ping avg: ${avg.toFixed(1)} ms`);
    }

    async function runDownload(base) {
      const mb = Number($("dlSize").value || 100);
      const totalBytes = mb * 1024 * 1024;
      const url = `${base}/download?size=${totalBytes}&chunk=${64*1024}&_=${Math.random()}`;

      const controller = new AbortController();
      abortDownload = () => controller.abort("user");
      const t0 = performance.now();
      let received = 0;

      log(`‚¨áÔ∏è Downloading ${mb} MB‚Ä¶`);

      const resp = await fetch(url, { cache: "no-store", signal: controller.signal });
      const reader = resp.body.getReader();

      try {
        while (true) {
          const { done, value } = await reader.read();
          if (done) break;
          received += value.length;

          const secs = (performance.now() - t0) / 1000;
          const mbps = secs > 0 ? (received * 8) / (secs * 1024 * 1024) : 0;
          $("downVal").textContent = mbps.toFixed(2) + " Mbps";
          $("downBar").style.width = Math.min(100, (received / totalBytes) * 100) + "%";

          if (aborted) { controller.abort("user"); break; }
        }
      } catch (err) {
        if (err?.name !== "AbortError") throw err;
      }

      const secs = (performance.now() - t0) / 1000;
      if (!aborted) {
        const finalMbps = (received * 8) / (secs * 1024 * 1024);
        $("downVal").textContent = isFinite(finalMbps) ? finalMbps.toFixed(2) + " Mbps" : "‚Äì";
        $("downBar").style.width = "100%";
        log(`‚úÖ Download complete in ${secs.toFixed(2)}s @ ${finalMbps.toFixed(2)} Mbps`);
      } else {
        log("‚èπÔ∏è Download aborted.");
      }
    }

    async function runUpload(base) {
      const mb = Number($("ulSize").value || 20);
      const totalBytes = mb * 1024 * 1024;

      log(`‚¨ÜÔ∏è Preparing ${mb} MB upload buffer‚Ä¶`);
      const chunk = 1024 * 1024; 
      const parts = [];
      for (let sent = 0; sent < totalBytes; sent += chunk) {
        const size = Math.min(chunk, totalBytes - sent);
        const arr = new Uint8Array(size);
        for (let i = 0; i < size; i++) arr[i] = (i * 31 + sent) & 0xff;
        parts.push(arr);
      }
      const blob = new Blob(parts, { type: "application/octet-stream" });

      log(`‚¨ÜÔ∏è Uploading ${mb} MB‚Ä¶`);
      const t0 = performance.now();
      const resp = await fetch(base + "/upload", {
        method: "POST",
        body: blob,
        headers: { "Content-Type": "application/octet-stream" },
        cache: "no-store"
      });
      const data = await resp.json();
      const secs = (performance.now() - t0) / 1000;
      const mbps = (data.size * 8) / (secs * 1024 * 1024);

      $("upVal").textContent = mbps.toFixed(2) + " Mbps";
      $("upBar").style.width = "100%";
      log(`‚úÖ Upload complete in ${secs.toFixed(2)}s @ ${mbps.toFixed(2)} Mbps`);
    }
  </script>
</body>
</html>
